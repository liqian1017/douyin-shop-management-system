<?php
/**
 * 模板下载文件
 * 提供各种模板文件下载
 */

require_once '../config.php';
require_once '../app/Auth.php';

// 启动会话
if (session_status() === PHP_SESSION_NONE) {
    session_start();
}

// 检查登录
$auth = new Auth();
if (!$auth->isLoggedIn()) {
    die('请先登录');
}

// 获取模板类型
$type = $_GET['type'] ?? 'simple_shops';

// 模板配置
$templates = [
    'simple_shops' => [
        'filename' => '店铺批量导入模板.csv',
        'headers' => [
            '法人姓名', '营业执照名称', '抖音店铺ID', '开店手机号',
            '店铺名称', '主账号邮箱', '开店日期', '店铺状态',
            '余额', '保证金', '备注'
        ],
        'sample_data' => [
            [
                '张三', '北京科技有限公司', 'shop_001', '13800138000',
                '张三的小店', 'shop001@example.com', '2024-01-01', 'active',
                '1000.00', '5000.00', '首批导入店铺'
            ],
            [
                '李四', '上海贸易有限公司', 'shop_002', '13800138001', 
                '李四优选', 'shop002@example.com', '2024-01-02', 'active',
                '2000.00', '5000.00', '优质商家'
            ],
            [
                '王五', '深圳电商有限公司', 'shop_003', '13800138002',
                '王五精品店', 'shop003@example.com', '2024-01-03', 'reviewing',
                '0.00', '5000.00', '新开店铺'
            ]
        ]
    ],
    
    'simple_guide' => [
        'filename' => '导入说明文档.txt',
        'content' => '抖音店铺管理系统 - 简化导入说明

====================================
必填字段（共4个）
====================================
1. 法人姓名      - 法定代表人姓名，可重复使用现有法人
2. 营业执照名称   - 营业执照上的公司名称，可重复使用现有执照
3. 抖音店铺ID    - 抖音平台的店铺唯一标识，必须唯一
4. 开店手机号    - 用于开店的手机号码，可重复

====================================
可选字段（系统会自动填充默认值）
====================================
• 店铺名称      - 不填写时自动生成
• 主账号邮箱    - 不填写时自动生成
• 开店日期      - 不填写时使用当前日期
• 店铺状态      - 不填写时默认为"active"
• 余额         - 不填写时默认为0
• 保证金       - 不填写时默认为0
• 备注         - 可选备注信息

====================================
智能处理说明
====================================
✅ 自动创建法人：如果法人姓名不存在，系统会自动创建
✅ 自动创建执照：如果营业执照名称不存在，系统会自动创建
✅ 重复利用：相同法人姓名和执照名称会重复使用
✅ 唯一性检查：抖音店铺ID必须唯一，重复会导入失败
✅ 默认值填充：可选字段为空时自动填充合理默认值

====================================
文件格式要求
====================================
• 文件格式：CSV（逗号分隔值）
• 编码格式：UTF-8（推荐）或GBK
• 文件大小：不超过10MB
• 数据行数：建议每次导入不超过1000行

====================================
常见问题解答
====================================
Q: 如何处理法人信息不完整的情况？
A: 系统会使用默认值，后续可在法人管理中补充完整信息

Q: 营业执照可开店数如何设置？
A: 新建执照默认可开5个店，可在营业执照管理中修改

Q: 导入失败怎么办？
A: 查看导入日志中的错误提示，修正数据后重新导入

Q: 可以部分导入吗？
A: 可以，系统会跳过错误行，继续处理正确的数据

====================================
联系支持
====================================
如遇到导入问题，请联系系统管理员
系统版本：MVC精简版 v1.0
更新时间：' . date('Y-m-d') . '
'
    ]
];

// 检查模板类型
if (!isset($templates[$type])) {
    die('无效的模板类型');
}

$template = $templates[$type];

try {
    // 设置下载头
    header('Content-Type: application/octet-stream');
    header('Content-Disposition: attachment; filename="' . $template['filename'] . '"');
    header('Cache-Control: must-revalidate, post-check=0, pre-check=0');
    header('Pragma: public');
    
    if ($type === 'simple_guide') {
        // 文本文档
        echo $template['content'];
    } else {
        // CSV文件
        $output = fopen('php://output', 'w');
        
        // UTF-8 BOM
        fwrite($output, "\xEF\xBB\xBF");
        
        // 输出标题行
        fputcsv($output, $template['headers']);
        
        // 输出示例数据
        foreach ($template['sample_data'] as $row) {
            fputcsv($output, $row);
        }
        
        fclose($output);
    }
    
} catch (Exception $e) {
    error_log('模板下载错误: ' . $e->getMessage());
    die('模板生成失败');
}
?>